# New Layer tool
This folder contains a tool written to allow the addition of a yet to be implemented layer in HLS4ML.
It is still a work in progress, but simple layers seem to work well and can be registered, tested and hls-compiled.
The idea comes from some difficulties in finding all the pieces to register an InstanceNormalization for an Anomaly Detection Neural Network used to select new physics from a known background without an a priori theory.

## Files

* `layer_writer.py`: main script invoked to use the tool. To create a layer a `config.yaml` file must be provided with the `--config-file` flag;
* `config.yaml`: configuration file example (see next section);
* `py_impl_template.txt`: template text file used by the main script to produce the Python script where all the functions needed to define and register the new layer will be stored;
* `hls_impl_template.h`: template header file used by the main script to produce the hls/C++ implementation of the new layer which will be used automatically by the compiler after the layer will be registered in HLS4ML;
* `init_template.txt`: template text file for the `__init__.py` script which lets the user do the registration with a simple import.

### Configuration File

The `config.yaml` file is structured in the following way:

* `Pyconfig`: all the configuration for the "Python side" of the implementation:
	* `layername`: name of the layer used for naming the output folder and files, classes and functions;
	* `layerlongname`: "official" name of the layer used in Tensorflow, e.g. `Addons>InstanceNormalization` in the tensorflow_addons library;
	* `attrlist`: all variables used in the building and computation of the layer:
		* `Attribute`: general attributes;
		* `WeightAttribute`: name of the weights;
		* `TypeAttribute`: name of the weights' type, usually the same as their name (a type called `<weightname>_t` will be created);
	* `genattrtypes`: python types of the general attributes (for now only native types were tested, the `str` type is converted to `std::string` when used in the hls header);
	* `genattrdef`: default values for the general attributes;
	* `otherargs`: list of arguments of the actual function containing the description of the layer computation in the hls header;
	* `attrdef`: definition of general attributes inside the C++ function (this can be done also manually in the header generated by the tool).
* `CConfig`: not yet implemented, the user has to write the inside of the C++ function manually in the header file produced by the tool.
